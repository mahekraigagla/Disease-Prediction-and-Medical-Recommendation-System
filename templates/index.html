<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HealthBot - Disease Prediction Assistant</title>
    <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#f0f2f5; height:100vh; overflow:hidden; display:flex; justify-content:center; align-items:center; }
    .main-container { width:95%; max-width:1200px; height:90vh; display:flex; border-radius:20px; box-shadow:0 5px 25px rgba(0,0,0,.15); overflow:hidden; background:#fff; }

    .sidebar { width:30%; background: linear-gradient(180deg, #36c, #6a89cc); color:#fff; padding:30px 20px; display:flex; flex-direction:column; justify-content:space-between; }
    .sidebar-header h1 { font-size:1.8rem; font-weight:700; margin-bottom:5px; }
    .sidebar-header p { font-size:1rem; opacity:.9; }
    .sidebar-section { margin-top:40px; flex:1; }
    .sidebar-section h3 { font-size:1.05rem; margin:14px 0 6px; }
    .sidebar-section p { opacity:.95; }
    .start-session { background:rgba(255,255,255,.15); color:#fff; border:0; border-radius:25px; padding:12px 18px; font-size:1rem; cursor:pointer; }

    .chat-area { width:70%; display:flex; flex-direction:column; background:#fff; }
    .chat-header { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); color:#fff; padding:16px 20px; display:flex; justify-content:space-between; align-items:center; }
    .header-actions { display:flex; gap:10px; align-items:center; }
    .toggle-btn { cursor:pointer; background:#ffffff20; color:#fff; border:1px solid #ffffff30; border-radius:20px; padding:6px 12px; font-size:.9rem; }

    .chat-body { flex:1; padding:20px; overflow-y:auto; background:#f7f7fb; }
    .message { margin:10px 0; padding:12px 14px; border-radius:12px; max-width:75%; line-height:1.5; word-wrap:break-word; }
    .user-message { background:#667eea; color:#fff; margin-left:auto; border-bottom-right-radius:0; }
    .bot-message { background:#e5e5ea; color:#111; border-bottom-left-radius:0; }

    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { background:#eef; color:#334; border:1px solid #ccd; padding:6px 10px; border-radius:16px; cursor:pointer; font-size:.9rem; }
    .chip.no { background:#fee; color:#633; border-color:#f6c; }

    .candidates { margin-top:8px; }
    .candidate { background:#fff; border:1px solid #ddd; border-radius:10px; padding:10px; margin:8px 0; }
    .bar { height:6px; background:#eee; border-radius:6px; overflow:hidden; margin-top:6px; }
    .bar > span { display:block; height:100%; background:#667eea; }

    .chat-input { display:flex; align-items:center; padding:14px; background:#f0f0f0; border-top:1px solid #ddd; gap:10px; }
    .chat-input input { flex:1; padding:12px 15px; border:1px solid #ccc; border-radius:25px; font-size:1rem; outline:none; }
    .chat-input button { background:#667eea; color:#fff; border:0; border-radius:25px; padding:12px 20px; font-size:1rem; cursor:pointer; }
    .mic { background:#10b981; }

    /* Autocomplete dropdown */
    .suggest-box { position:relative; }
    .suggest-list { position:absolute; left:0; right:0; top:100%; background:#fff; border:1px solid #ddd; border-radius:10px; z-index:10; overflow:hidden; }
    .suggest-item { padding:8px 10px; cursor:pointer; }
    .suggest-item:hover { background:#f0f0ff; }

    /* Dark mode */
    body.dark { background:#0f1220; color:#e5e7eb; }
    body.dark .main-container { background:#111827; }
    body.dark .sidebar { background: linear-gradient(180deg,#111827,#1f2937); }
    body.dark .chat-header { background: linear-gradient(90deg,#374151,#4b5563); }
    body.dark .chat-body { background:#0f172a; }
    body.dark .bot-message { background:#1f2937; color:#e5e7eb; }
    body.dark .user-message { background:#4f46e5; }
    body.dark .chat-input { background:#111827; border-top-color:#1f2937; }

    body.large-font { font-size:18px; }

    @media (max-width:900px){ .main-container{ flex-direction:column; height:auto;} .sidebar{ width:100%; flex-direction:row; justify-content:space-around; align-items:center;} .chat-area{ width:100%; } }
    </style>
</head>
<body>
  <div class="main-container">
    <div class="sidebar">
      <div>
        <div class="sidebar-header">
          <h1>ğŸ¤– HealthBot</h1>
                <p>Your AI Health Assistant</p>
            </div>
        <div class="sidebar-section">
          <h3>ğŸ‘¤ Patient</h3>
          <p id="patient-info">Not provided yet</p>
          <h3>ğŸ’Š Symptoms</h3>
                    <p id="symptoms-info">Not provided yet</p>
          <h3>ğŸ“Š Status</h3>
          <p id="status-info">In progress</p>
        </div>
      </div>
      <button class="start-session" id="resetBtn">ğŸ”„ Start New Session</button>
    </div>

    <div class="chat-area">
            <div class="chat-header">
        <h2>HealthBot - Disease Prediction Assistant</h2>
        <div class="header-actions">
          <button id="emergencyBtn" class="toggle-btn" style="background:#dc3545;color:#fff;" onclick="showHospitals()">ğŸš¨ Emergency</button>
          <button id="downloadBtn" class="toggle-btn">Download Report</button>
          <button id="darkBtn" class="toggle-btn">Dark Mode</button>
          <button id="fontBtn" class="toggle-btn">A+</button>
                </div>
            </div>

      <div class="chat-body" id="chat">
        <div class="message bot-message">
          Hello! ğŸ‘‹ I'm HealthBot.<br/>
          I'm here to help with disease prediction and medical recommendations.<br/>
          Let's start by getting to know you.<br/><br/>
          <strong>Whatâ€™s your name?</strong>
                </div>
            </div>

                <div class="chat-input">
        <div class="suggest-box" style="flex:1;">
          <input id="input" type="text" placeholder="Type your answer..." />
          <div id="suggest" class="suggest-list" style="display:none;"></div>
                </div>
        <button id="mic" class="mic">ğŸ¤</button>
        <button id="send">Send</button>
            </div>
        </div>
        </div>

    <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const suggestBox = document.getElementById('suggest');
    const micBtn = document.getElementById('mic');

    const state = { step:'name', name:'', age:'', gender:'', symptoms:[], negatives:[], duration_days:null, trend:null, askedTimeline:false, lastPrediction:null, allSymptoms:[], lastSuggestions:[] };

    fetch('/symptom_list').then(r=>r.json()).then(list=> state.allSymptoms = list);

    function appendBot(html, speak=false){ const el=document.createElement('div'); el.className='message bot-message'; el.innerHTML=html; chat.appendChild(el); chat.scrollTop=chat.scrollHeight; if(speak){ try{ const u=new SpeechSynthesisUtterance(el.textContent); speechSynthesis.speak(u);}catch(e){} } }
    function appendUser(text){ const el=document.createElement('div'); el.className='message user-message'; el.textContent=text; chat.appendChild(el); chat.scrollTop=chat.scrollHeight; }
    function updateSidebar(){
      const patient = [state.name,state.age,state.gender].filter(Boolean).join(', ')
      document.getElementById('patient-info').textContent = patient || 'Not provided yet';
      const all = state.symptoms.concat(state.negatives.map(n=>'no '+n));
      document.getElementById('symptoms-info').textContent = all.join(', ') || 'Not provided yet';
      if(state.duration_days!=null || state.trend){
        document.getElementById('status-info').textContent = `In progress${state.duration_days!=null?`, ${state.duration_days}d`:''}${state.trend?`, ${state.trend}`:''}`;
      }
    }
    function reset(){ chat.innerHTML = `<div class="message bot-message">Hello! ğŸ‘‹ I'm HealthBot.<br/>I'm here to help with disease prediction and medical recommendations.<br/>Let's start by getting to know you.<br/><br/><strong>Whatâ€™s your name?</strong></div>`; input.placeholder='Type your answer...'; input.value=''; state.step='name'; state.name=''; state.age=''; state.gender=''; state.symptoms=[]; state.negatives=[]; state.lastPrediction=null; updateSidebar(); document.getElementById('status-info').textContent='In progress'; suggestBox.style.display='none'; suggestBox.innerHTML=''; }

    document.getElementById('resetBtn').addEventListener('click', reset);

    function chipsHtml(items){ state.lastSuggestions = items.slice(); return `<div class="chips">${items.map(s=>`<span class="chip" data-yes="${s}">${s}</span>`).join('')}</div><div style="margin-top:6px;color:#555;font-size:.9rem;">Type "none of these" to skip these suggestions.</div>`; }
    chat.addEventListener('click', async (e)=>{ const yes=e.target.getAttribute?.('data-yes'); if(yes){ state.symptoms.push(yes); updateSidebar(); appendUser(yes); await maybePredict(); } });

    function fuzzySuggest(text, limit=6){ const t=text.toLowerCase(); if(!t) return []; return state.allSymptoms.map(s=>({s,score: similarity(t,s)})).sort((a,b)=>b.score-a.score).slice(0,limit).map(x=>x.s); }
    function similarity(a,b){ // simple token overlap + prefix
      const A=a.split(/\s+/), B=b.split(/\s+/); const setB=new Set(B); let overlap=0; A.forEach(x=>{ if(setB.has(x)) overlap++; }); const pref=b.startsWith(a)?1:0; return overlap + pref + (a && b ? (1-Math.min(1, Math.abs(b.length-a.length)/Math.max(b.length,1)))*0.3:0); }

    function showSuggestions(){
      const t=input.value.trim();
      const key=t.toLowerCase();
      if(["none of these","i have none of these","none","no"].includes(key) && state.lastSuggestions.length){
        // Mark current suggestions as negatives and fetch new ones
        const addNeg = state.lastSuggestions.filter(s=>!state.symptoms.includes(s) && !state.negatives.includes(s));
        if(addNeg.length){ state.negatives = state.negatives.concat(addNeg); updateSidebar(); appendUser(t); input.value=''; state.lastSuggestions=[]; maybePredict(); }
        suggestBox.style.display='none'; suggestBox.innerHTML='';
        return;
      }
      if(!t){ suggestBox.style.display='none'; suggestBox.innerHTML=''; return; }
      const items=fuzzySuggest(t);
      if(!items.length){ suggestBox.style.display='none'; return; }
      suggestBox.innerHTML = items.map(s=>`<div class="suggest-item" data-sugg="${s}">${s}</div>`).join('');
      suggestBox.style.display='block';
    }
    input.addEventListener('input', showSuggestions);
    suggestBox.addEventListener('click', (e)=>{ const s=e.target.getAttribute?.('data-sugg'); if(s){ input.value=s; suggestBox.style.display='none'; }});

    function extractFromParagraph(text){ const lower=text.toLowerCase(); const found=[]; for(const s of state.allSymptoms){ if(lower.includes(s)) found.push(s); } return found; }

    async function maybePredict(){
      document.getElementById('status-info').textContent='Thinking...';
      const res = await fetch('/predict', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: state.name, age: state.age, gender: state.gender, symptoms: state.symptoms.join(','), negatives: state.negatives, duration_days: state.duration_days, trend: state.trend }) });
      const data = await res.json();
      if(data.error){ appendBot(`âŒ ${data.error}`); document.getElementById('status-info').textContent='Awaiting input'; return; }

      // Check for emergency alerts first
      if(data.emergency_alerts && data.emergency_alerts.length > 0){
        document.getElementById('status-info').textContent='EMERGENCY DETECTED';
        let emergencyHtml = '<div style="background:#ff4444;color:#fff;padding:15px;border-radius:10px;margin:10px 0;">';
        for(const alert of data.emergency_alerts){
          emergencyHtml += `<div style="margin:5px 0;"><strong>${alert.message}</strong></div>`;
        }
        emergencyHtml += '</div>';
        emergencyHtml += '<div style="background:#fff3cd;color:#856404;padding:10px;border-radius:8px;margin:10px 0;">';
        emergencyHtml += '<strong>Emergency Contacts:</strong><br/>';
        emergencyHtml += 'ğŸš‘ Ambulance: 108<br/>';
        emergencyHtml += 'ğŸ‘® Police: 100<br/>';
        emergencyHtml += 'ğŸ”¥ Fire: 101<br/>';
        emergencyHtml += '<button onclick="showHospitals()" style="background:#dc3545;color:#fff;border:none;padding:8px 15px;border-radius:5px;margin-top:10px;cursor:pointer;">Find Nearest Hospitals</button>';
        emergencyHtml += '</div>';
        appendBot(emergencyHtml, true);
        
        // Still show prediction if available
        if(data.top_k && data.top_k.length){
          let html = `<br/><strong>Current candidates:</strong>`;
          html += `<div class="candidates">${data.top_k.map(c=>`<div class="candidate"><div><strong>${c.disease}</strong> (${(c.prob*100).toFixed(0)}%)</div><div class="bar"><span style="width:${(c.prob*100).toFixed(0)}%"></span></div></div>`).join('')}</div>`;
          appendBot(html, true);
        }
        return;
      }

      if(data.need_more){
        document.getElementById('status-info').textContent='Need more symptoms';
        let html = `I need a few more details to improve accuracy. ${data.top_k?.length?'<br/><br><strong>Current candidates:</strong>':''}`;
        if(data.top_k && data.top_k.length){ html += `<div class="candidates">${data.top_k.map(c=>`<div class="candidate"><div><strong>${c.disease}</strong> (${(c.prob*100).toFixed(0)}%)</div><div class="bar"><span style="width:${(c.prob*100).toFixed(0)}%"></span></div></div>`).join('')}</div>`; }
        if(data.suggested_symptoms && data.suggested_symptoms.length){ html += `<br/><strong>Do you have any of these?</strong>${chipsHtml(data.suggested_symptoms)}`; }
        appendBot(html, true);
        return;
      }

      state.lastPrediction = data;
      document.getElementById('status-info').textContent='Prediction complete';
      
      let resultHtml = `<strong>Disease Predicted:</strong> ${data.predicted_disease}<br/><br/>`;
      
      // Check for red flags
      if(data.red_flags && data.red_flags.length > 0){
        resultHtml += '<div style="background:#ff6b6b;color:#fff;padding:15px;border-radius:10px;margin:10px 0;">';
        for(const flag of data.red_flags){
          resultHtml += `<div style="margin:5px 0;"><strong>${flag.message}</strong></div>`;
        }
        resultHtml += '</div>';
      }
      
      resultHtml += `<strong>Description:</strong> ${data.dis_des}<br/><br/>`;
      resultHtml += `<strong>Precautions:</strong> ${data.my_precautions.join(', ')}<br/><br/>`;
      resultHtml += `<strong>Medications:</strong> ${data.medications.join(', ')}<br/><br/>`;
      resultHtml += `<strong>Diet:</strong> ${data.my_diet.join(', ')}<br/><br/>`;
      resultHtml += `<strong>Workout:</strong> ${data.workout.join(', ')}`;
      
      // Add emergency contact button if red flags detected
      if(data.red_flags && data.red_flags.length > 0){
        resultHtml += '<br/><br/><button onclick="showHospitals()" style="background:#dc3545;color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin-top:10px;">Find Nearest Hospitals</button>';
      }
      
      appendBot(resultHtml, true);
    }

    async function handleSend(){
      const text = input.value.trim(); if(!text) return; appendUser(text); input.value=''; suggestBox.style.display='none';
      if(state.step==='name'){ state.name=text; state.step='age'; updateSidebar(); appendBot(`Nice to meet you, <strong>${state.name}</strong>! ğŸ‰<br/><br/>How old are you?`); return; }
      if(state.step==='age'){ state.age=text; state.step='gender'; updateSidebar(); appendBot(`Thanks! What's your gender? (Male/Female/Other)`); return; }
      if(state.step==='gender'){ state.gender=text; state.step='symptoms'; updateSidebar(); appendBot(`Great. Please describe your symptoms (comma-separated or a sentence). You can also click suggestions when I show them.`); input.placeholder='e.g., headache, fever, nausea'; return; }
      if(state.step==='symptoms'){
        const parts = text.includes(',') ? text.split(',').map(s=>s.trim()).filter(Boolean) : extractFromParagraph(text);
        for(const p of parts){ if(!state.symptoms.includes(p)) state.symptoms.push(p); }
            updateSidebar();
        if(!state.askedTimeline){
          state.askedTimeline = true;
          appendBot('Since when do you have these symptoms? Please enter days (e.g., 5).');
          state.step = 'duration';
          return;
        }
        await maybePredict();
        return;
      }
      if(state.step==='duration'){
        const n = parseInt(text, 10);
        if(!isNaN(n) && n >= 0){ state.duration_days = n; }
        appendBot('Are your symptoms getting worse, better, or stable?');
        state.step = 'trend';
        return;
      }
      if(state.step==='trend'){
        const t = text.toLowerCase();
        if(['worse','better','stable'].includes(t)) state.trend = t;
        updateSidebar();
        state.step = 'symptoms';
        await maybePredict();
        return;
      }
    }

    sendBtn.addEventListener('click', handleSend);
    input.addEventListener('keypress', (e)=>{ if(e.key==='Enter') handleSend(); });

    // Mic input (basic Web Speech API)
    let recognizing=false; let rec;
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if(SR){ rec = new SR(); rec.lang='en-US'; rec.onresult=(e)=>{ const t=e.results[0][0].transcript; input.value = input.value ? (input.value+ ' ' + t) : t; showSuggestions(); }; rec.onend=()=>{ recognizing=false; micBtn.textContent='ğŸ¤'; } }
    } catch(e){}
    micBtn.addEventListener('click', ()=>{ if(!rec) return; if(recognizing){ rec.stop(); recognizing=false; micBtn.textContent='ğŸ¤'; } else { rec.start(); recognizing=true; micBtn.textContent='â¹'; }});

    document.getElementById('darkBtn').addEventListener('click', ()=> document.body.classList.toggle('dark'));
    document.getElementById('fontBtn').addEventListener('click', ()=> document.body.classList.toggle('large-font'));

    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const d = state.lastPrediction;
      const w = window.open('', '_blank');
      const body = `
        <h2>HealthBot Report</h2>
        <p><strong>Patient:</strong> ${state.name||'-'} | <strong>Age:</strong> ${state.age||'-'} | <strong>Gender:</strong> ${state.gender||'-'}</p>
        <p><strong>Symptoms:</strong> ${state.symptoms.concat(state.negatives.map(n=>'no '+n)).join(', ')||'-'}</p>
        ${d?`<hr/><p><strong>Predicted Disease:</strong> ${d.predicted_disease}</p>
        <p><strong>Description:</strong> ${d.dis_des}</p>
        <p><strong>Precautions:</strong> ${d.my_precautions.join(', ')}</p>
        <p><strong>Medications:</strong> ${d.medications.join(', ')}</p>
        <p><strong>Diet:</strong> ${d.my_diet.join(', ')}</p>
        <p><strong>Workout:</strong> ${d.workout.join(', ')}</p>`:''}`;
      w.document.write(`<!DOCTYPE html><html><head><title>Report</title></head><body>${body}</body></html>`);
      w.document.close(); w.focus(); w.print();
    });

    // Emergency functions
    async function showHospitals(){
      try {
        const response = await fetch('/hospitals');
        const hospitals = await response.json();
        
        let hospitalHtml = '<div style="background:#e8f5e8;padding:15px;border-radius:10px;margin:10px 0;">';
        hospitalHtml += '<h3 style="color:#2d5a2d;margin-bottom:15px;">ğŸ¥ Nearest Hospitals</h3>';
        
        hospitals.forEach(hospital => {
          hospitalHtml += `<div style="background:#fff;padding:10px;margin:10px 0;border-radius:8px;border-left:4px solid #28a745;">`;
          hospitalHtml += `<strong>${hospital.name}</strong><br/>`;
          hospitalHtml += `ğŸ“ ${hospital.address}<br/>`;
          hospitalHtml += `ğŸ“ ${hospital.phone}<br/>`;
          hospitalHtml += `ğŸ“ ${hospital.distance}<br/>`;
          hospitalHtml += `ğŸ¥ Emergency Services: ${hospital.emergency_services ? 'Yes' : 'No'}<br/>`;
          hospitalHtml += `âš•ï¸ Specialties: ${hospital.specialties.join(', ')}`;
          hospitalHtml += `</div>`;
        });
        
        hospitalHtml += '</div>';
        hospitalHtml += '<div style="background:#fff3cd;color:#856404;padding:10px;border-radius:8px;margin:10px 0;">';
        hospitalHtml += '<strong>Emergency Contacts:</strong><br/>';
        hospitalHtml += 'ğŸš‘ Ambulance: 108<br/>';
        hospitalHtml += 'ğŸ‘® Police: 100<br/>';
        hospitalHtml += 'ğŸ”¥ Fire: 101<br/>';
        hospitalHtml += 'ğŸ‘© Women Helpline: 1091<br/>';
        hospitalHtml += 'ğŸ‘¶ Child Helpline: 1098';
        hospitalHtml += '</div>';
        
        appendBot(hospitalHtml, true);
      } catch (error) {
        appendBot('âŒ Error fetching hospital information. Please call emergency services directly.', true);
      }
    }

    function callEmergency(number){
      if(confirm(`Call emergency number ${number}?`)){
        window.open(`tel:${number}`, '_self');
      }
    }

    reset();
    </script>
</body>
</html>